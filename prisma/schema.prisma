generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

// --- Enum 설정 ---
enum UserRole {
  USER
  ADMIN
  HEAD_ADMIN
}

enum Attendance {
  ATTENDANCE
  ABSENT
}

enum ParticipationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// 1. 유저 정보
model User {
  id          Int      @id @default(autoincrement())
  name        String?  // 4주차 추가 예정
  email       String   @unique
  password    String?  // SNS 가입 고려
  nickname    String   @unique
  bio         String?  @db.Text
  provider    String   @default("LOCAL")
  providerId  String?  @map("provider_id")
  role        UserRole @default(USER)
  createdAt   DateTime @default(now()) @map("created_at")

  interests      UserInterest[]
  meetings       Meeting[]        @relation("HostedMeetings")
  participations Participation[]
  messages       ChatMessage[]

  @@map("users")
}

// 2. 관심사 마스터
model Interest {
  id    Int    @id @default(autoincrement())
  name  String @unique

  userInterests UserInterest[]
  meetings      Meeting[]

  @@map("interests")
}

// 3. 유저-관심사 연결 (N:M 관계 해소)
model UserInterest {
  id         Int @id @default(autoincrement())
  userId     Int @map("user_id")
  interestId Int @map("interest_id")

  user     User     @relation(fields: [userId], references: [id])
  interest Interest @relation(fields: [interestId], references: [id])

  @@map("user_interests")
}

// 4. 모임 정보
model Meeting {
  id              Int      @id @default(autoincrement())
  title           String
  description     String   @db.Text
  interestId      Int      @map("interest_id")
  maxParticipants Int      @map("max_participants")
  meetingDate     DateTime @map("meeting_date")
  
  address         String
  latitude        Float
  longitude       Float
  
  hostId          Int      @map("host_id")
  createdAt       DateTime @default(now()) @map("created_at")

  interest       Interest        @relation(fields: [interestId], references: [id])
  host           User            @relation("HostedMeetings", fields: [hostId], references: [id])
  participations Participation[]
  messages       ChatMessage[]

  @@map("meetings")
}

// 5. 참여 신청 내역
model Participation {
  id         Int                 @id @default(autoincrement())
  userId     Int                 @map("user_id")
  meetingId  Int                 @map("meeting_id")
  status     ParticipationStatus @default(PENDING)
  checkedIn  Attendance?         @map("checked_in")
  createdAt  DateTime            @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id])
  meeting Meeting @relation(fields: [meetingId], references: [id])

  @@unique([userId, meetingId]) // 중복 신청 방지
  @@map("participations")
}

// 6. 채팅 기록
model ChatMessage {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  senderId  Int      @map("sender_id")
  meetingId Int      @map("meeting_id")
  createdAt DateTime @default(now()) @map("created_at")

  sender  User    @relation(fields: [senderId], references: [id])
  meeting Meeting @relation(fields: [meetingId], references: [id])

  @@map("chat_messages")
}